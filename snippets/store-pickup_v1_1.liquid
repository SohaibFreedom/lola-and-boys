<!-- DO NOT EDIT THIS FILE. ANY CHANGES WILL BE OVERWRITTEN -->
<link rel="stylesheet" href="https://shopify-pickup-app.herokuapp.com/styles/classic.css" id="theme_base">
<script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/jquery.validation/1.16.0/jquery.validate.min.js"></script>
<script type="text/javascript" src="https://shopify-pickup-app.herokuapp.com/js/picker.js"></script>
<script type="text/javascript" src="https://shopify-pickup-app.herokuapp.com/js/picker.date.js"></script>
<script type="text/javascript" src="https://shopify-pickup-app.herokuapp.com/js/picker.time.js"></script>

<!-- Need updated version of jQuery for validate library -->
<script>var $jq = $.noConflict(true);</script>

<style type="text/css">
    #pickup-store-search {
        background-position: 10px 12px;
        /* Position the search icon */
        background-repeat: no-repeat;
        /* Do not repeat the icon image */
        font-size: 16px;
        /* Increase font-size */
        padding: 12px 20px 12px 12px;
        /* Add some padding */
        border: 1px solid #ddd;
        /* Add a grey border */
        margin-bottom: 12px;
        /* Add some space below the input */
    }

    #storeUL {
        list-style-type: none;
        padding: 0;
        margin: 0;
        overflow: auto;
    }

    #storeUL li {
        margin-bottom: 5px;
    }

    #storeUL li a {
        padding: 12px;
        /* Add some padding */
        text-decoration: none;
        /* Remove default text underline */
        display: block;
        /* Make it into a block element to fill the whole list */
    }

    #storeUL li a.header {
        background-color: #e2e2e2;
        /*Darker background for headers */
        cursor: default;
        /* Change cursor style */
    }

    #storeUL li a:hover:not(.header) {
        background-color: #eee;
        /* Add a hover effect to all links, except for headers */
    }

    .activeStore {
        background: #cccccc;
        /* Background for currently selected store */
    }

    #pickup-header {
        font-size: 0.95em;
        text-decoration: none;
        display: inline;
        position: relative;
        top: -15px;
    }

    #pickup-box {
        vertical-align: middle;
    }

    .pickup-hidden {
        display: none!important;
    }

    #pickup-details{
        min-width: 260px;
    }

    #pickup-details input{
        width:100%;
    }

    .hide{
        display: none!important;
    }
    #pickup-container{
        display: flex;
        -ms-flex-direction: column;
        flex-direction: column;
        margin-bottom: 1rem;
        margin-top: 1rem;
        text-align: left;
        align-items: flex-end;
    }
    .pickup-button{
        border: 1px solid #efefef;
        border-radius: 2px;
        padding: 10px;
        margin-bottom: 20px;
        display: inline-block;
        text-align: center;
        margin-top: 20px;
        cursor: pointer;
    }

    .selected{
        /*background: #f7f7f7;*/
        /*border: 1px solid #e6e6e6;*/
        opacity: 0.6;
    }

    #pickup-container .error{
        color: #ff0000;
    }



</style>
<script type="text/javascript">
    //$jq('#pickup-details').on('DOMSubtreeModified', function(){console.log('updated')})
</script>

<div id="pickup-container" style="display:none;">
  <div id="pickup-header"></div>
  <div class="js-toggle-pickup pickup-button btn btn--small-wide">
      <span></span>
  </div>
  <!-- Name of person picking up etc -->
  <div id="pickup-details" style="display:none;">
      <div class="js-stores-position-1"></div>
      <label id="pickup-date-label" for="pickup-date">Pickup Date</label>
      <!--<input type="date" id="pickup-date-start" name="pickup-date-start">-->
      <div style="position:relative">
          <input type="text" class="datepicker" id="pickup-date-start" name="pickup-date-start" readonly>
      </div>
      <label id="pickup-date-start-error" class="valid" for="pickup-date-start" style="display: none;"></label>

      <label id="pickup-name-label"for="pickup-name">Name of Person Collecting</label>
      <input style="margin-bottom: 0px;" type="text" id="pickup-name" name="pickup-name" placeholder="Your name">

      <label id="pickup-number-label" for="pickup-number">Contact Number</label>
      <input type="text" id="pickup-number" name="pickup-number" placeholder="" />

      <div class="js-stores-position-2"></div>

      <!-- Extra input 1 -->
      <div class="extra_input_1_wrapper">
          <label id="extra_input_1_label" for="extra_input_1">Extra</label>
          <input type="text" id="extra_input_1" name="extra_input_1" placeholder="" />
      </div>

      <!-- Extra input 2 -->
      <div class="extra_input_2_wrapper">
          <label id="extra_input_2_label" for="extra_input_2">Extra</label>
          <input type="text" id="extra_input_2" name="extra_input_2" placeholder="" />
      </div>

      <!-- Extra input 3 -->
      <div class="extra_input_3_wrapper">
          <label id="extra_input_3_label" for="extra_input_3">Extra</label>
          <input type="text" id="extra_input_3" name="extra_input_3" placeholder="" />
      </div>

      <div class="js-storepickup-message"></div>
      <input type="hidden" id="pickup-attribute" name="attributes[pickup]" value="0">
  </div>

  <div style="display:none;">
      {% for p in cart.items%} {% for c in p.product.collections %}
      <span class="product-collection">{{ c.title }}</span> {% endfor %} {% endfor %}
  </div>

</div>

<script type="text/javascript">

    var pickupProductID = "7212815188026"; // Variant ID of pickup in store product
    var address = "835 Michigan Ave";
    var locale = "en";
    var country = "United States";
    var city = "Chicago";
    var zip = "60611";
    var company = "Lola &amp; The Boys";

    var myForm = $jq('form')[n];

    var collections = [];
    var settings = "";
    var stores = "";

    // If settings aren't blank, load. Else set to default settings
    if ('{"max_days":"","min_days":"0","name":true,"phone":true,"date_enabled":false,"mandatory_collections":[],"blackoutDates":"2018,10,22-2018,11,25","cart_version":"v1_1","disabled":false,"message":"","button_text":"","extra_input_1":"","extra_input_2":"","extra_input_3":"","above_weight":""}' != "") {
        settings = JSON.parse('{"max_days":"","min_days":"0","name":true,"phone":true,"date_enabled":false,"mandatory_collections":[],"blackoutDates":"2018,10,22-2018,11,25","cart_version":"v1_1","disabled":false,"message":"","button_text":"","extra_input_1":"","extra_input_2":"","extra_input_3":"","above_weight":""}');

        for (var c in settings.mandatory_collections) {
            collections.push(settings.mandatory_collections[c].title.replace(/'/g, '&apos;'));
        }
    } else {
        settings = { // Default settings
            'max_days': 0,
            'min_days' : 1,  // 0 = Same day pickup, 1 = tomorrow etc
            'name': true,
            'phone': true,
            'mandatory_collections': [],
            'date_enabled' : true
        };
    };

    // Stores position
    var storesTemplate = '<div id="store-search">' +
        '              <label for="pickup-store-search">Pickup Store</label>' +
        '              <input type="text" name="pickup-store-search" id="pickup-store-search" onkeyup="storeFilter()" placeholder="Choose a location below for pick up">' +
        '              <input type="hidden" name="pickup-store" id="pickup-store">' +
        '              <!-- Where store value gets saved for validation -->' +
        '              <ul id="storeUL"></ul>' +
        '          </div>';
    if (settings.stores_on_top) {
        $jq('.js-stores-position-1').html(storesTemplate);
    } else {
        $jq('.js-stores-position-2').html(storesTemplate);
    }


    // Pickup button text
    var cr_button_text = settings.button_text == undefined? 'Pick Up In Store' : settings.button_text;
    if (cr_button_text == '') cr_button_text = 'Pick Up In Store';
    $jq(document).ready(function() {
        $jq('.pickup-button > span').text(cr_button_text);
    });

    if (settings.message !== undefined && settings.message != '') {
        $jq('.js-storepickup-message').html(settings.message);
    }

    // Make sure each property is in settings (for users who have updated cart script but not updated settings)
    if (!'min_days' in settings) {
        settings['min_days'] = 1;
    };

    if (!'date_enabled' in settings) {
        settings['date_enabled'] = true;
    };

    if (settings.disabled === true) {
        $jq('#pickup-container').addClass('hide');
    }
    // If multiple stores
    if ('[{"storeID":3815,"name":"Lola & The Boys","company":"Lola & The Boys","street":"835 Michigan Ave","city":"Chicago","country":"United States","zip":"60611","province":"IL"}]' != "") {
        stores = JSON.parse('[{"storeID":3815,"name":"Lola & The Boys","company":"Lola & The Boys","street":"835 Michigan Ave","city":"Chicago","country":"United States","zip":"60611","province":"IL"}]');
    };

    // Make sure at least one setting is set. If no settings, hide the pickup box
    if (settings.date_enabled || settings.phone || settings.name || stores.length > 1) {
        $jq('#pickup-container').css('display', 'flex');
    } else {
        $jq('#pickup-container').css('display', 'none');
    };


    var pickupCompany = "Lola &amp; The Boys";
    var pickupAddress = "835 Michigan Ave";
    var pickupCity = "Chicago";
    var pickupCountry = "United States";
    var pickupZip = "60611";
    var pickupProvince = "IL";
    var pickupLocale = "en";
    var shopPhone = "3127538809";

    // Pickup mandatory if any products in cart have this collection. eg Projectiles
    var product_collections = []; // All collections from all products in cart

    var startDate = document.getElementsByName('pickup-date-start'); // Start date for pickup
    //var endDate = document.getElementsByName('pickup-date-end'); //  End date for pickup

    var phone = $jq('#pickup-number');
    var name = $jq('#pickup-name');
    var pickupStore = ""; // Name of store where customer is picking up

    if (settings.customCSS) {
      var link = document.createElement('link')
      link.setAttribute('rel', 'stylesheet')
      link.setAttribute('type', 'text/css')
      link.setAttribute('href', '{{ "store-pickup.css" | asset_url }}' )
      document.getElementsByTagName('head')[0].appendChild(link)
    };

    var shippingInfo = "?step=contact_information&checkout[shipping_address][company]=" + pickupCompany + "&checkout[shipping_address][phone]=" + phone.val() + "&checkout[shipping_address][address1]=" + pickupAddress +
        "&checkout[shipping_address][city]=" + pickupCity + "&checkout[shipping_address][country]=" + pickupCountry + "&checkout[shipping_address][zip]=" + pickupZip + "&checkout[shipping_address][province]=" + pickupProvince + "&locale=" +
        pickupLocale;


    var pickupBoxChange = function() {
        // For when pickup checkbox is changed.
        //console.log('Pick up box change')
        // If user has selected to pickup or cart contains pickup product
        //if ($jq('#pickup-box').is(':checked')
        if($jq('.js-toggle-pickup').hasClass('selected')) {
            $jq('#pickup-attribute').val('1');
            $jq('#pickup-details').show();

            addCartItems(pickupProductID, function(){});

            // Hide/show date
            if (settings.date_enabled) {
              // If enabled, add validation rules
              $jq("#pickup-date-start").rules('add', {
                  "required": true,
                  "messages": {
                      "required": "Please enter a pickup date."
                  }
              });
            } else {
                // If not enabled, hide
                $jq('#pickup-date-start').css('display', 'none');
                $jq('#pickup-date-label').css('display', 'none');
                $jq('.pickup-date-label-span').css('display', 'none');
            };

            // Hide/show phone
            if (settings.phone) {
                $jq("#pickup-number").rules('add', {
                    "required": true,
                    "messages": {
                        "required": "Please enter a phone number."
                    }
                });
            } else {
                // $jq("#pickup-number").rules('remove');
                $jq('#pickup-number').css('display', 'none');
                $jq('#pickup-number-label').css('display', 'none');
            }

            // Hide/show name
            if (settings.name) {
                $jq('#pickup-name').rules('add', {
                    required: true,
                    messages: {
                        required: "Please enter who will be picking up your order."
                    }
                });
            } else {
                $jq('#pickup-name').css('display', 'none');
                $jq('#pickup-name-label').css('display', 'none');
            };

            // Hide/show store search
            if (stores.length > 1) {
                // var rules = ($jq('#pickup-store').rules());
                // console.log(rules);
                $jq('#pickup-store-search').rules('add', {
                    "required": true,
                    "messages": {
                        "required": "Please select which store you will pick up from"
                    }
                });
            } else {
                $jq('#store-search').css('display', 'none'); // Hide store search
            }

            $jq('#pickup-details').css('display', 'inline'); // Show extra info
        } else {
            $jq('#pickup-attribute').val('0');
            $jq("#pickup-date-start").rules('remove');
            $jq("#pickup-number").rules('remove');
            $jq('#pickup-name').rules('remove');
            $jq('#pickup-store-search').rules('remove');

            // Pickup not checked. Hide display.
            $jq('#pickup-details').css('display', 'none'); // Hide extra info

            getCartItems(function(response){
              // Check each item in cart to see if Pickup product currently in the cart
              for (var item in response.items) {
                  if (response.items[item].variant_id == pickupProductID) {
                      changeCartItems(pickupProductID, 0, function(res) {
                          location.reload();
                      });
                  };
              };
            })
        };
    };

    var storeFilter = function() {
        // Filters stores by search
        // Declare variables
        var input, filter, ul, li, a, i;
        input = document.getElementById('pickup-store-search');
        filter = input.value.toUpperCase();
        ul = document.getElementById("storeUL");
        li = ul.getElementsByTagName('li');

        // Loop through all list items, and hide those who don't match the search query
        for (i = 0; i < li.length; i++) {
            a = li[i].getElementsByTagName("a")[0];
            if (a.innerHTML.toUpperCase().indexOf(filter) > -1) {
                li[i].style.display = "";
            } else {
                li[i].style.display = "none";
            }
        }
    };

    var getCartItems = function(callback) {
        // Get items currently in the cart
        $jq.ajax({
            url: '/cart.js',
            type: 'GET',
            dataType: 'json',
            success: function(response) {
                if (callback !== null) {
                    callback(response)
                }
            },
            error: function(e) {
                console.log('Error!', e);
            }
        });
    };

    var addCartItems = function(variantId, callback) {
        //console.log('___ adding cart items');
        // Product data for pickup product
        getCartItems(function(response) {
            var inCart = false; // Assume not currently in cart

            // Check each item in cart to see if Pickup product currently in the cart
            for (var item in response.items) {
                if (response.items[item].variant_id == variantId) {
                    inCart = true;
                };
            };

            // Not in cart, add pickup product to cart
            if (inCart === false) {
                var productData = {
                    quantity: 1,
                    id: variantId
                };

                $jq.ajax({
                    type: "POST",
                    url: "/cart/add.js",
                    data: productData,
                    success: function() {
                        callback();
                    },
                    error: function(err) {
                        console.log(err);
                    },
                    dataType: "json"
                });
            } else {
                callback();
            }

        });
    };

    var changeCartItems = function(variantId, productQty, callback) {
        // Changes quantity of item in cart to 0.
        var productData = {
            quantity: productQty,
            id: variantId
        };
        $jq.post('/cart/change.js', productData, function(res, err) {
            if (err != "success") {
                console.log(err);
            } else {
                callback(res);
            }
        }, 'json');
    };

    var setOrderNotes = function() {
        // Returns existing cart notes + pickup details. Then submits form
        var notesText = '';
        $jq("textarea[name=note]").each(function(){
            notesText += $jq(this).val() + " ";
        });

        var name = $jq('#pickup-name');
        var phoneNumber = $jq('#pickup-number');
        var pickupDate = $jq('#pickup-date-start');
        //var notesText = $jq('textarea[name="note"]').val();
        var pickUpInformation = "Pickup Information:";

        var extra_input_1 = $jq('#extra_input_1').val();
        var extra_input_2 = $jq('#extra_input_2').val();
        var extra_input_3 = $jq('#extra_input_3').val();

        if (pickupStore != "") {
            pickUpInformation += "\n" + "Store: " + pickupStore.replace(/<br>/g, "\n");
        }

        if (name.val() != "") {
            pickUpInformation += "\n" + "Name of person collecting: " + name.val();
        }

        if (pickupDate.val() != "") {
            pickUpInformation += "\n" + "Pickup Date: " + pickupDate.val();
        }

        if (phoneNumber.val() != "") {
            pickUpInformation += "\n" + "Phone: " + phone.val();
        }

        // Extra input 1
        if (settings.extra_input_1 && extra_input_1) {
            pickUpInformation += "\n" + settings.extra_input_1 + " : " + extra_input_1;
        }

        // Extra input 2
        if (settings.extra_input_2 && extra_input_2) {
            pickUpInformation += "\n" + settings.extra_input_2 + " : " + extra_input_2;
        }

        // Extra input 3
        if (settings.extra_input_3 && extra_input_3) {
            pickUpInformation += "\n" + settings.extra_input_3 + " : " + extra_input_3;
        }

        if (notesText != "") {
            $jq('textarea[name="note"]').val(notesText + "\n" + pickUpInformation); // Add current notes + info
        } else {
            $jq('textarea[name="note"]').val(pickUpInformation); // Just add info
        };
    };

    var updateCartNotes = function(orderNotes, callback) {
        var params = {
            type: 'POST',
            url: '/cart/update.js',
            data: 'note=' + orderNotes,
            dataType: 'json',
            success: function() {
                console.log('Updated cart');
                callback;
            },
            error: function(XMLHttpRequest, textStatus) {
                console.log(XMLHttpRequest, textStatus);
            }
        };
        $jq.ajax(params);
    };

    $jq("#storeUL").on("click", ".searchTerm", function(e) {
        // Make class active
        // If already selected, unselect
        if ($jq(this).attr('class').includes('activeStore')) {
            $jq(this).removeClass('activeStore');
            pickupStore = "";
            $jq('#pickup-store').val(pickupStore);
            $jq('#pickup-store-search').val(pickupStore)
            $jq('.js-chosen-store').remove();
        } else {
            pickupStore = ($jq(this).children("a")[0].innerHTML);
            var zipCode = $jq(this).children("a")[0].getAttribute('data-zip-code');
            var address = $jq(this).children("a")[0].getAttribute('data-address');
            var chosenCity = $jq(this).children("a")[0].getAttribute('data-city');
            var chosenProvince = $jq(this).children("a")[0].getAttribute('data-province');
            var chosenCountry = $jq(this).children("a")[0].getAttribute('data-country');
            var storeName = $jq(this).children("a")[0].getAttribute('data-name');
            $jq("#storeUL li").removeClass('activeStore'); // Clear class from all li
            $jq('.js-chosen-store').remove();
            $jq(this).addClass('activeStore');
            $jq('#pickup-store').val(pickupStore);
            $jq('#pickup-store-search').val(pickupStore)
            $jq('#pickup-store-search').after(
                '<span class="js-chosen-store">' + storeName + '<br> ' +
                'Address: ' + address + '<br>' +
                'Zip: ' + zipCode
                + '</span>'
            )
            pickupStore = storeName + '<br> ' +
                'Address: ' + address + '<br>' +
                'Zip: ' + zipCode;

            //Update autofilling data for the checkout page
            shippingInfo = "?step=contact_information&checkout[shipping_address][company]=" + storeName
                + "&checkout[shipping_address][phone]=" + phone.val()
                + "&checkout[shipping_address][address1]=" + address
                + "&checkout[shipping_address][city]=" + chosenCity
                + "&checkout[shipping_address][country]=" + chosenCountry
                + "&checkout[shipping_address][zip]=" + zipCode
                + "&checkout[shipping_address][province]=" + chosenProvince
                + "&checkout[shipping_address][county]=" + chosenProvince
                + "&locale=" + pickupLocale;
        };

        e.preventDefault();
    });



    // If multiple stores in settings, show store search
    if (stores.length > 1) {
        // Show store-search
        var store = [];
        var ul = document.getElementById("storeUL");
        $jq('.pickup-store-search').prop('required', true);
        for (var n in stores) {
            $jq(ul).append('<li id= ' + stores[n].storeID + ' class="searchTerm">' +
                '<a href="#" ' +
                'data-zip-code="' + stores[n].zip + '" '
                + 'data-address="' + stores[n].street + '"'
                + 'data-name="' + stores[n].name + '"'
                + 'data-city="' + stores[n].city + '"'
                + 'data-country="' + stores[n].country + '"'
                + 'data-province="' + stores[n].province + '"'
                + '">'
                + stores[n].name + ' - ' + stores[n].city
                + '</a></li>');
        }
    } else {
        var search = document.getElementById('store-search');
        $jq(search).toggle();
    };


    // If pickup product already in the cart, make pickup checkbox checked
    var inCart = false; // Assume not currently in cart
    getCartItems(function(response) {
        let giftCard = true;
        //console.log('~~ Get cart items')
        var requestedAboveWeight = settings.above_weight || '';
        var isUnderWeight = true; // consider the cart weight are not above the requested weight

        // Check each item in cart to see if currently in the cart
        for (var item in response.items) {
            if (response.items[item].gift_card !== true) {
                giftCard = false;
            }

            if (response.items[item].handle != 'store-pickup-app' && requestedAboveWeight && isUnderWeight && response.items[item].grams > (requestedAboveWeight * 1000)){
                isUnderWeight = false;
            }

            if (response.items[item].variant_id == pickupProductID) {
                inCart = true;
            }
        }

        if (giftCard === true) {
            $jq('#pickup-container').addClass('hide');
        }

        if (isUnderWeight === true && requestedAboveWeight != '') {
            $jq('#pickup-container').addClass('hide');
        }

        var gotMandatoryProduct = false;
        $jq('.product-collection').each(function(c) {
            //console.log($jq(this).text())
            if (collections.includes($jq(this).text().replace(/'/g, '&apos;'))) {
                gotMandatoryProduct = true;
            }
        });
        console.log('inCart: ', inCart);
        if (gotMandatoryProduct === true) {
            // Make mandatory, by hidding the option
            //$jq('#pickup-button').addClass('pickup-hidden');
            // not needed //$jq('.js-toggle-pickup').addClass('hide');

            $jq('#pickup-header').text('An item in your cart must be collected');
            $jq('#pickup-details').css('display', 'inline');
            inCart = true;

            //not needed
            /*if(!$jq('.js-toggle-pickup').hasClass('selected')){
                $jq('.js-toggle-pickup').addClass('selected');
            }*/

            // We don't need to call pickupBoxChange, as this will be called here inCart == true
            // Validator library is not being loaded very fast, that's why we add this delay
            // setTimeout(function(){
            //     pickupBoxChange();
            // }, 300);
        }
        if (inCart == true) {
            // Make mandatory.
            //$jq('#pickup-box').prop('checked', true);
            $jq('.js-toggle-pickup').addClass('hide');
            if(!$jq('.js-toggle-pickup').hasClass('selected')){
                $jq('.js-toggle-pickup').addClass('selected');
            }
            // $jq(window).bind("load", function() {
            //     setTimeout(function(){
            //         pickupBoxChange();
            //     }, 400);
            // });
            var checkExist = setInterval(function() {
                if ($jq('#pickup-details').length) {
                    console.log("Exists!");
                    clearInterval(checkExist);
                    pickupBoxChange();
                }
            }, 100);
        }
        //console.log('got mandatory product', gotMandatoryProduct)
    });

    var notes = $jq('textarea[name="note"]'); // Cart Notes

    // If user goes back from checkout, clean pickup information from notes.
    if (notes != undefined && notes.val() != undefined && notes.val().includes("Pickup Information")) {
        var existingNotes = notes.val();
        var cleanNotes = existingNotes.substring(0, existingNotes.indexOf('Pickup Information:'));
        notes.val(cleanNotes);
    }


    $jq(document).ready(function() {
        var pickupInstalled = false;
        var togglePickupContainer = function() {
            if (pickupInstalled === false || settings.disabled === true) {
                $jq('#pickup-container').css("display", "none");
            } else {
                $jq('#pickup-container').css("display", "flex");
            }
        };

        // Make sure app is still installed
        $jq.ajax({
            type: "GET",
            url: "https://shopify-pickup-app.herokuapp.com/isInstalled",
            data: {shop:"lola-and-the-boys-2.myshopify.com"},
            // async: false,
            success: function(res) {
                if (res.error) {
                    pickupInstalled = false;
                    togglePickupContainer();
                } else {
                    pickupInstalled = true;
                    // Must remove the required attribute to avoid validation errors
                    $jq('#cart_agree').removeAttr('required');
                    togglePickupContainer();
                }
            },
            error: function(err) {
                console.log(err);
                if ('lola-and-the-boys-2.myshopify.com' == 'silver-nutmeg.myshopify.com' || 'lola-and-the-boys-2.myshopify.com' == 'chop2chisel.myshopify.com'){
                    pickupInstalled = true;
                    togglePickupContainer();
                } else {
                    pickupInstalled = false;
                    togglePickupContainer();
                }

            },
            dataType: "json"
        });

        // Gets the cart form (and previously appended prefilled checkout info)
        var foundForm = false;
        for (var n in $jq('form')) {
            var testForm = $jq('form')[n]; // Create $jq to test the form attributes
            if(testForm.attributes && testForm.attributes.class && testForm.attributes.class.value == 'mini-cart') continue;
            if (testForm.attributes && testForm.attributes.action && testForm.attributes.action.value.indexOf('/cart') > -1
                && testForm.attributes.class
                && testForm.attributes.class.value.indexOf('cart') > -1
                && testForm.attributes.action.value.indexOf('/add') < 0
            ) { // We have a winner
                var myForm = $jq(testForm);
                foundForm = true;
                break
            };
        };
        if (!foundForm) {
            for (var n in $jq('form')) {
                var testForm = $jq('form')[n]; // Create $jq to test the form attributes
                if(testForm.attributes && testForm.attributes.class && testForm.attributes.class.value == 'mini-cart') continue;
                if(testForm.attributes && testForm.attributes.class && testForm.attributes.class.value.indexOf('mm-menu') > -1) continue;
                if (testForm.attributes && testForm.attributes.action && testForm.attributes.action.value.indexOf('/cart') > -1
                    && testForm.attributes.action.value.indexOf('/add') < 0
                ) { // We have a winner
                    var myForm = $jq(testForm);
                    foundForm = true;
                    break
                };
            };
        }
        if (!foundForm) {
            for (var n in $jq('form')) {
                var testForm = $jq('form')[n]; // Create $jq to test the form attributes
                if(testForm.attributes && testForm.attributes.class && testForm.attributes.class.value == 'mini-cart') continue;
                if (testForm.attributes && testForm.attributes.action && testForm.attributes.action.value.indexOf('/checkout') > -1
                    && testForm.attributes.action.value.indexOf('/add') < 0
                ) { // We have a winner
                    var myForm = $jq(testForm);
                    foundForm = true;
                    break
                };
            };
        }

        var numDaysBetween = function(d1, d2) {
            // Return number of days between two dates
            var diff = Math.abs(d1.getTime() - d2.getTime());
            return diff / (1000 * 60 * 60 * 24);
        };

        function showDateError(errorMsg) {
            // Manually shows error message on date field
            $jq('#pickup-date-start-error').css('display', 'block'); // Show error message
            $jq('#pickup-date-start-error').text(errorMsg);
            $jq('#pickup-date-start').addClass('error').removeClass('valid');
            $jq('#pickup-date-start').attr('aria-invalid', "true");
        };

        function clearDateErrors() {
            $jq('#pickup-date-start-error').css('display', 'none'); // Show error message
            $jq('#pickup-date-start').addClass('valid').removeClass('error');
            $jq('#pickup-date-start').attr('aria-invalid', "false");
        };

        if (!myForm) return;
        var submitForm = myForm[0] || '';
        if (submitForm == '') return;

        $jq('input[name="checkout"]').on('click', function(){
            $jq(submitForm).attr('action', '/checkout');
        });

        $jq('button[name="checkout"]').on('click', function(){
            $jq(submitForm).attr('action', '/checkout');
        });

        $jq(submitForm).validate({
            //ignore: '*:not([name])'
        });

        $jq('body').on('click tap', '[name="checkout"], [name="goto_pp"], [name="goto_gc"], [aria-label="Apple Pay"]', function(e) {
            var handler = $jq(this);
            var formValid = $jq(submitForm).valid();
            console.log(formValid);
            if ($jq('#pickup-container').is(":visible") && $jq('.pickup-button').hasClass('selected') && $jq('.activeStore').attr('id') === undefined && stores !== undefined && stores.length> 1) {
                formValid = false;
                $jq('.searchTerm').css('display', 'block')
                $jq('#pickup-store-search').val('')
                $jq('#pickup-store-search-error').text('Please select which store you will pick up from')
                $jq('#pickup-store-search-error').css('display', 'block')
            } else {
                $jq('#pickup-store-search-error').text('')
                $jq('#pickup-store-search-error').css('display', 'none')
            }
            if (formValid) {
                if ($jq('.js-toggle-pickup').hasClass('selected')) {
                    $jq(submitForm).attr('action', '/checkout?' + shippingInfo + '&locale=en-pickup');
                    if (settings.date_enabled) {
                        // Make sure date is valid
                        var chosenDate = new Date($jq('#pickup-date-start').val());
                        var todayDate = new Date();

                        if (chosenDate.getTime() < todayDate.getTime()) {
                            // Check to see if they have enabled same day pickup (value will be between 0 and -1)
                            if (settings.min_days == 0 && numDaysBetween(chosenDate, todayDate) < 1) {
                                // If so, submit form as usual
                                clearDateErrors();
                                setOrderNotes();
                                handler.submit();
                            } else {
                                showDateError("Pickup date must be in the future.");
                                return false;
                            };
                        } else if (settings.max_days != 0 && Math.ceil(numDaysBetween(chosenDate, todayDate)) > settings.max_days) {
                            showDateError("Pickup date must be within " + settings.max_days + " days.");
                            return false;
                        } else if (Math.round(numDaysBetween(chosenDate, todayDate)) < settings.min_days) {
                            showDateError("Pickup date must be at least " + settings.min_days + " days away.");
                            return false;
                        } else {
                            // Date is fine. Submit form
                            clearDateErrors();
                            setOrderNotes();
                            handler.submit();
                        };
                    } else {
                        // Date not enabled, just submit form
                        clearDateErrors();
                        setOrderNotes();
                        handler.submit();
                    }
                } else {
                    // Pickup box not selected. Submit form
                    $jq(submitForm).attr('action', '/checkout?&locale=' + pickupLocale);
                    handler.submit();
                };
            } else {
                $jq('html, body').animate({
                    scrollTop: $jq("#pickup-container").offset().top - 300
                }, 2000);
                return false;
            }
        });

        // If user has gone form shipping stage back to cart, the pickup product will be in the cart and checkbox will be checked.
        // If they uncheck the product (meaning they don't want store pickup. Remove the product from the cart.

        // setTimeout(function(){
        //!! moved inside getCartItems callback ~L622
        //     if (inCart == true) {
        //         // Make mandatory.
        //         //$jq('#pickup-box').prop('checked', true);
        //         $jq('.js-toggle-pickup').addClass('hide');
        //         if(!$jq('.js-toggle-pickup').hasClass('selected')){
        //             $jq('.js-toggle-pickup').addClass('selected');
        //         }
        //         pickupBoxChange();
        //     } else {
        //         //$jq('#pickup-box').prop('checked', false);
        //         $jq('.js-toggle-pickup').removeClass('selected');
        //     }
        //
        // }, 200);



        // Double check to make sure notes are cleaned in case page loaded too slow
        //var notes = $jq('textarea[name="note"]'); // Cart Notes
        var notes = myForm.find('textarea[name="note"]');

        // If user goes back from checkout, clean pickup information from notes.
        if (notes != undefined && notes.val() != undefined && notes.val().includes("Pickup Information")) {
            var existingNotes = notes.val();
            var cleanNotes = existingNotes.substring(0, existingNotes.indexOf('Pickup Information:'));
            notes.val(cleanNotes);
        };

        var yesterday = new Date((new Date()).valueOf() - 1000 * 60 * 60 * 36);
        var maxDays = settings.max_days && settings.max_days != 0? new Date((new Date()).valueOf() + 1000 * 60 * 60 * settings.max_days * 24) : '';
        var minDays = settings.min_days && settings.min_days != 0? new Date((new Date()).valueOf() + 1000 * 60 * 60 * settings.min_days * 24) : new Date();
        var todayPickup = settings.same_day_pickup? yesterday : new Date(); // blackout today if same day pickup is not set
        var $input = $jq('.datepicker').pickadate({
            today: '',
            clear: '',
            close: '',
            min: minDays,
            max:  maxDays
            ,disable: [
                todayPickup
            ]
        })
        var picker = $input.pickadate('picker');
        //picker.set('min', true)

        if (settings.blackoutDates) {
            let blackoutdates = settings.blackoutDates.split('-')

            let blackoutdatesCollection = [];
            for (let i in blackoutdates) {
                let chunks = (blackoutdates[i] + '').split(',');
                blackoutdatesCollection.push(chunks);
            }
            picker.set('disable', blackoutdatesCollection);
        }


        $jq('.js-toggle-pickup').on('click tap', function(){
            $jq(this).toggleClass('selected');
            console.log('activated');
            pickupBoxChange();
        });

        // Display extra fields
        // Hide/show extra 1
        if (settings.extra_input_1 && settings.extra_input_1.trim() !== '') {
            $jq('#extra_input_1_label').text(settings.extra_input_1.replace(/\&apos;/g, '\''));
            $jq('#extra_input_1').rules('add', {
                "required": true,
                "messages": {
                    "required": "You must complete this field"
                }
            });
        } else {
            $jq('.extra_input_1_wrapper').css('display', 'none');
        }

        // Hide/show extra 2
        if (settings.extra_input_2 && settings.extra_input_2.trim() !== '') {
            $jq('#extra_input_2_label').text(settings.extra_input_2.replace(/\&apos;/g, '\''));
            $jq('#extra_input_2').rules('add', {
                "required": true,
                "messages": {
                    "required": "You must complete this field"
                }
            });
        } else {
            $jq('.extra_input_2_wrapper').css('display', 'none');
        }

        // Hide/show extra 3
        if (settings.extra_input_3 && settings.extra_input_3.trim() !== '') {
            console.log('extra input 3', settings.extra_input_3);


            $jq('#extra_input_3_label').text(settings.extra_input_3.replace(/\&apos;/g, '\''));
            $jq('#extra_input_3').rules('add', {
                "required": true,
                "messages": {
                    "required": "You must complete this field"
                }
            });
        } else {
            $jq('.extra_input_3_wrapper').css('display', 'none');
        }

    });
</script>
