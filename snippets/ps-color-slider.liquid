{{ 'ps-color-slider.css' | asset_url | stylesheet_tag }}

<div class="product-media-slider-wrapper" id="PsColorSlider-{{ product.id }}"
    data-product-json='{{ product | json | escape }}'>
    <div class="swiper product-media-slider">
        <div class="swiper-wrapper">
            {% for media in product.media %}
            <div class="swiper-slide" data-media-id="{{ media.id }}" data-alt="{{ media.alt | downcase | escape }}">
                <div class="media-box">
                    {%- case media.media_type -%}
                    {%- when 'image' -%}
                    <img src="{{ media | img_url: '700x' }}" alt="{{ media.alt | escape }}" class="slider-media"
                        loading="lazy">
                    {%- when 'video' -%}
                    <video class="slider-media" autoplay muted loop playsinline>
                        {%- for source in media.sources -%}
                        <source src="{{ source.url }}" type="{{ source.mime_type }}">
                        {%- endfor -%}
                    </video>
                    {%- when 'external_video' -%}
                    {%- if media.host == 'youtube' -%}
                    <iframe class="slider-media ext-vid"
                        src="https://www.youtube.com/embed/{{ media.external_id }}?autoplay=1&loop=1&mute=1&playlist={{ media.external_id }}&controls=0&modestbranding=1&rel=0"
                        allow="autoplay; encrypted-media" allowfullscreen></iframe>
                    {%- elsif media.host == 'vimeo' -%}
                    <iframe class="slider-media ext-vid"
                        src="https://player.vimeo.com/video/{{ media.external_id }}?autoplay=1&loop=1&muted=1&background=1"
                        allow="autoplay; fullscreen" allowfullscreen></iframe>
                    {%- endif -%}
                    {%- endcase -%}
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="swiper-button-prev custom-arrow" aria-label="Previous">
            <!-- ✅ UPDATED SVG (LEFT) -->
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48" fill="none" style="transform:rotate(180deg)">
                <path d="M27 9L42 24M42 24L27 39M42 24H6" stroke="#2D2A26" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </div>

        <div class="swiper-button-next custom-arrow" aria-label="Next">
            <!-- ✅ UPDATED SVG (RIGHT) -->
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48" fill="none">
                <path d="M27 9L42 24M42 24L27 39M42 24H6" stroke="#2D2A26" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </div>

        <div class="swiper-pagination"></div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const root = document.getElementById("PsColorSlider-{{ product.id }}");
        if (!root) return;

        const productData = JSON.parse(root.getAttribute("data-product-json"));
        const wrapper = root.querySelector(".swiper-wrapper");
        const allSlides = Array.from(wrapper.querySelectorAll(".swiper-slide")).map(s => s.cloneNode(true));
        let swiper = null;

        const mq = window.matchMedia("(max-width: 768px)");
        let isMobile = mq.matches;
        mq.addEventListener?.("change", (e) => {
            isMobile = e.matches;
            rebuildSlides(currentFilteredSlides || allSlides);
            initSwiper();
        });

        function bindBulletClicks(sw) {
  const bullets = sw.pagination?.bullets || sw.pagination?.el?.querySelectorAll(".swiper-pagination-bullet");
  if (!bullets) return;

  bullets.forEach((b, i) => {
    if (b.__psBound) return;      // ✅ double binding prevent
    b.__psBound = true;

    b.addEventListener("click", function (e) {
      e.preventDefault();
      e.stopPropagation();
      if (e.stopImmediatePropagation) e.stopImmediatePropagation();

      // ✅ Exact jump on any dot
      if (sw.params.loop) sw.slideToLoop(i);
      else sw.slideTo(i);
    }, true); // ✅ CAPTURE mode (important)
  });
}


        function initSwiper() {
            if (swiper && swiper.destroy) swiper.destroy(true, true);

            const baseOpts = {
                slidesPerView: 2,
                loop: true,
                speed: 700,
                spaceBetween: 5,
                observer: true,
                observeParents: true,
                navigation: { nextEl: ".swiper-button-next", prevEl: ".swiper-button-prev" },
                autoplay: false,

                pagination: { el: ".swiper-pagination", clickable: true },
                on: {
  afterInit(sw) { bindBulletClicks(sw); },
  paginationUpdate(sw) { bindBulletClicks(sw); }
},

                breakpoints: {
                    0: { slidesPerView: 1, slidesPerGroup: 1 },
                    768: { slidesPerView: 1, slidesPerGroup: 1 },
                    1025: { slidesPerView: 2, slidesPerGroup: 1 }
                }
            };

            swiper = new Swiper(".product-media-slider", baseOpts);
        }

        let currentFilteredSlides = null;
        function rebuildSlides(slidesArr) {
            currentFilteredSlides = slidesArr.slice();

            if (isMobile) {
                wrapper.innerHTML = "";
                (slidesArr.length ? slidesArr : allSlides).forEach(node => wrapper.appendChild(node.cloneNode(true)));
                return;
            }

            let slides = slidesArr.slice();
            const MIN = 3;
            if (slides.length === 0) slides = allSlides.slice();

            function nextDifferent(startIdx, lastId) {
                for (let off = 0; off < slidesArr.length; off++) {
                    const cand = slidesArr[(startIdx + off) % slidesArr.length];
                    if (!lastId || cand.dataset.mediaId !== lastId) return cand;
                }
                return slidesArr[startIdx % slidesArr.length];
            }

            let i = 0;
            while (slides.length < MIN) {
                const lastId = slides.length ? slides[slides.length - 1].dataset.mediaId : null;
                const cand = nextDifferent(i, lastId);
                slides.push(cand.cloneNode(true));
                i++;
            }

            if (slides.length > 1 && slides[0].dataset.mediaId === slides[slides.length - 1].dataset.mediaId) {
                const cand = nextDifferent(0, slides[0].dataset.mediaId);
                if (cand) slides.push(cand.cloneNode(true));
            }

            wrapper.innerHTML = "";
            slides.forEach(node => wrapper.appendChild(node));
        }

        function filterSlidesByColor(colorValue) {
            const lc = (colorValue || "").toLowerCase().trim();
            const matched = allSlides.filter(slide => (slide.dataset.alt || "").toLowerCase().includes(lc));
            const filtered = matched.length ? matched : allSlides.slice();
            rebuildSlides(filtered);
            initSwiper();
        }

        const variantOptionIdx = productData.options.findIndex(o => /color|colour|style/i.test(o));
        const firstVariant = productData.variants.find(v => v.id === {{ product.selected_or_first_available_variant.id }});

    if (firstVariant && variantOptionIdx > -1) {
        filterSlidesByColor(firstVariant.options[variantOptionIdx]);
    } else {
        rebuildSlides(allSlides);
        initSwiper();
    }

    document.querySelectorAll(".swatch-element.color input[type='radio']").forEach(inp => {
        inp.addEventListener("change", () => filterSlidesByColor(inp.value || ""));
    });
});
</script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const swatches = document.querySelectorAll(".swatch input[type='radio'], .swatch label");

        swatches.forEach((swatch) => {
            ["click", "touchstart", "change"].forEach((eventType) => {
                swatch.addEventListener(eventType, () => {
                    let input = swatch.matches("input[type='radio']") ? swatch : null;

                    if (!input && swatch.tagName === "LABEL") {
                        const forId = swatch.getAttribute("for");
                        if (forId) input = document.getElementById(forId);
                    }

                    if (!input) return;

                    const wrapper = input.closest(".swatch");
                    const titleEl = wrapper ? wrapper.querySelector(".option_title") : null;
                    const title = titleEl ? titleEl.textContent.toLowerCase().trim() : "";

                    const isStyleOrColor = title.includes("style") || title.includes("color") || title.includes("colour");
                    if (!isStyleOrColor) return;

                    if (!swatch.classList.contains("swatch-reloading")) {
                        swatch.classList.add("swatch-reloading");
                        setTimeout(() => { location.reload(); }, 1000);
                    }
                });
            });
        });
    });
</script>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const ROOT_ID = "PsColorSlider-{{ product.id }}";
        const root = document.getElementById(ROOT_ID);
        if (!root) return;

        const FLAG = "__PS_FULLSCREEN_UPDATED__" + ROOT_ID;
        if (window[FLAG]) return;
        window[FLAG] = true;

        let modalEl = null;
        let lbSwiper = null;

        function getUniqueMediaFromDOM() {
            const slides = Array.from(root.querySelectorAll(".product-media-slider .swiper-wrapper .swiper-slide"));
            const map = new Map();

            slides.forEach(slide => {
                const id = slide.getAttribute("data-media-id") || slide.dataset.mediaId || "";
                if (!id || map.has(id)) return;

                const img = slide.querySelector("img.slider-media");
                const vid = slide.querySelector("video.slider-media");
                const ifr = slide.querySelector("iframe.slider-media");

                if (img) map.set(id, { id, type: "image", src: img.currentSrc || img.src, alt: img.getAttribute("alt") || "" });
                else if (vid) {
                    const source = vid.querySelector("source");
                    map.set(id, { id, type: "video", src: (source && source.src) ? source.src : "" });
                } else if (ifr) {
                    map.set(id, { id, type: "iframe", src: ifr.src });
                }
            });

            return Array.from(map.values());
        }

        function buildModal() {
            if (modalEl) return modalEl;

            modalEl = document.createElement("div");
            modalEl.className = "pslb-modal";
            modalEl.innerHTML = `
      <button class="pslb-close" type="button" aria-label="Close">×</button>

      <div class="pslb-nav pslb-prev" aria-label="Previous">
        <svg viewBox="0 0 10 6" xmlns="http://www.w3.org/2000/svg" style="transform:rotate(90deg)">
          <rect x="9.192" width="1" height="7" transform="rotate(45 9.192 0)" fill="currentColor"/>
          <rect x="0.707" width="7" height="1" transform="rotate(45 0.707 0)" fill="currentColor"/>
        </svg>
      </div>

      <div class="pslb-nav pslb-next" aria-label="Next">
        <svg viewBox="0 0 10 6" xmlns="http://www.w3.org/2000/svg" style="transform:rotate(-90deg)">
          <rect x="9.192" width="1" height="7" transform="rotate(45 9.192 0)" fill="currentColor"/>
          <rect x="0.707" width="7" height="1" transform="rotate(45 0.707 0)" fill="currentColor"/>
        </svg>
      </div>

      <div class="swiper pslb-swiper">
        <div class="swiper-wrapper"></div>
        <div class="swiper-pagination pslb-pagination"></div>
      </div>
    `;

            document.body.appendChild(modalEl);
            modalEl.querySelector(".pslb-close").addEventListener("click", closeLightbox);
            modalEl.addEventListener("click", (ev) => { if (ev.target === modalEl) closeLightbox(); });

            return modalEl;
        }

                // ✅ Lightbox videos autoplay + loop helper
        function autoPlayModalVideos(modal) {
            const vids = modal.querySelectorAll("video.pslb-video");
            vids.forEach(v => {
                try {
                    v.muted = true;
                    v.loop = true;
                    v.playsInline = true;
                    v.setAttribute("playsinline", "");
                    v.setAttribute("webkit-playsinline", "");
                    const p = v.play();
                    if (p && p.catch) p.catch(() => {});
                } catch (e) {}
            });
        }


        function openLightbox(startIndex) {
            const items = getUniqueMediaFromDOM();
            if (!items.length) return;

            const modal = buildModal();
            const wrap = modal.querySelector(".pslb-swiper .swiper-wrapper");
            wrap.innerHTML = "";

            items.forEach(item => {
                const slide = document.createElement("div");
                slide.className = "swiper-slide";

                if (item.type === "image") {
                    slide.innerHTML = `<div class="pslb-slide-inner">
          <img class="pslb-zoom-img" src="${item.src}" alt="${(item.alt || "").replace(/"/g, '&quot;')}" draggable="false"/>
        </div>`;
                                } else if (item.type === "video") {
                    slide.innerHTML = `<div class="pslb-slide-inner">
          <video
            class="pslb-video"
            autoplay
            muted
            loop
            playsinline
            playsInline
            webkit-playsinline
          >
            <source src="${item.src}">
          </video>
        </div>`;
                } else {

                    slide.innerHTML = `<div class="pslb-slide-inner">
          <iframe src="${item.src}" allow="autoplay; fullscreen" allowfullscreen></iframe>
        </div>`;
                }
                wrap.appendChild(slide);
            });

            document.body.classList.add("pslb-open");

            const canLoop = items.length > 1;

            if (lbSwiper && lbSwiper.destroy) lbSwiper.destroy(true, true);
            lbSwiper = new Swiper(modal.querySelector(".pslb-swiper"), {
                slidesPerView: 1,
                loop: canLoop,
                speed: 520,
                allowTouchMove: canLoop,
                resistanceRatio: 0,
                initialSlide: Math.max(0, Math.min(startIndex || 0, items.length - 1)),
                pagination: { el: modal.querySelector(".pslb-pagination"), clickable: true },
                navigation: { nextEl: modal.querySelector(".pslb-next"), prevEl: modal.querySelector(".pslb-prev") }
            });

            

                        // ✅ Lightbox videos autoplay / loop on open + slide change
            autoPlayModalVideos(modal);
            if (lbSwiper && lbSwiper.on) {
                lbSwiper.on("slideChangeTransitionEnd", function () {
                    autoPlayModalVideos(modal);
                });
            }

            installZoom(modal, lbSwiper);

        }

        function closeLightbox() {
            document.body.classList.remove("pslb-open");
            if (lbSwiper && lbSwiper.destroy) lbSwiper.destroy(true, true);
            lbSwiper = null;
            if (modalEl) { modalEl.remove(); modalEl = null; }
        }

        function installZoom(modal, swiperInstance) {
            modal.querySelectorAll(".swiper-slide").forEach(slide => {
                const img = slide.querySelector(".pslb-zoom-img");
                if (!img) return;

                if (!img.__panBound) {
                    img.__panBound = true;

                    let down = false, sx = 0, sy = 0, stx = 0, sty = 0;

                    const getNum = (v) => {
                        if (!v) return 0;
                        const n = parseFloat(String(v).replace("px", ""));
                        return Number.isFinite(n) ? n : 0;
                    };
                    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));

                    img.addEventListener("pointerdown", (ev) => {
                        if (!slide.classList.contains("pslb-zoomed")) return;
                        down = true;
                        img.classList.add("is-panning");
                        try { img.setPointerCapture(ev.pointerId); } catch (e) { }
                        sx = ev.clientX; sy = ev.clientY;
                        stx = getNum(getComputedStyle(img).getPropertyValue("--tx"));
                        sty = getNum(getComputedStyle(img).getPropertyValue("--ty"));
                        ev.preventDefault();
                        ev.stopPropagation();
                        if (ev.stopImmediatePropagation) ev.stopImmediatePropagation();
                    }, true);

                    img.addEventListener("pointermove", (ev) => {
                        if (!down || !slide.classList.contains("pslb-zoomed")) return;

                        const scale = parseFloat(getComputedStyle(img).getPropertyValue("--scale")) || 1;
                        const baseW = parseFloat(img.dataset.baseW || "0") || img.getBoundingClientRect().width;
                        const baseH = parseFloat(img.dataset.baseH || "0") || img.getBoundingClientRect().height;

                        const maxX = Math.max(0, (baseW * scale - baseW) / 2);
                        const maxY = Math.max(0, (baseH * scale - baseH) / 2);

                        const dx = ev.clientX - sx;
                        const dy = ev.clientY - sy;

                        const ntx = clamp(stx + dx, -maxX, maxX);
                        const nty = clamp(sty + dy, -maxY, maxY);

                        img.style.setProperty("--tx", ntx.toFixed(2) + "px");
                        img.style.setProperty("--ty", nty.toFixed(2) + "px");

                        ev.preventDefault();
                        ev.stopPropagation();
                        if (ev.stopImmediatePropagation) ev.stopImmediatePropagation();
                    }, true);

                    const end = (ev) => {
                        if (!down) return;
                        down = false;
                        img.classList.remove("is-panning");
                        try { img.releasePointerCapture(ev.pointerId); } catch (e) { }
                    };
                    img.addEventListener("pointerup", end, true);
                    img.addEventListener("pointercancel", end, true);
                    img.addEventListener("pointerleave", end, true);
                }

                slide.classList.remove("pslb-zoomed");
                img.style.setProperty("--scale", 1);
                img.style.setProperty("--tx", "0px");
                img.style.setProperty("--ty", "0px");
                img.style.setProperty("--ox", "50%");
                img.style.setProperty("--oy", "50%");
                img.dataset.baseW = "";
                img.dataset.baseH = "";

                function getPoint(ev) {
                    if (ev.touches && ev.touches[0]) return { x: ev.touches[0].clientX, y: ev.touches[0].clientY };
                    return { x: ev.clientX, y: ev.clientY };
                }
                function clamp2(n, min, max) { return Math.max(min, Math.min(max, n)); }

                function toggle(ev) {
                    const zoomed = slide.classList.contains("pslb-zoomed");
                    const pt = getPoint(ev);

                    if (zoomed) {
                        slide.classList.remove("pslb-zoomed");
                        img.style.setProperty("--scale", 1);
                        img.style.setProperty("--tx", "0px");
                        img.style.setProperty("--ty", "0px");
                        img.style.setProperty("--ox", "50%");
                        img.style.setProperty("--oy", "50%");
                        swiperInstance.allowTouchMove = swiperInstance.params.loop;
                        return;
                    }

                    const rect = img.getBoundingClientRect();
                    img.dataset.baseW = rect.width;
                    img.dataset.baseH = rect.height;

                    const x = clamp2(pt.x - rect.left, 0, rect.width);
                    const y = clamp2(pt.y - rect.top, 0, rect.height);

                    img.style.setProperty("--ox", ((x / rect.width) * 100).toFixed(2) + "%");
                    img.style.setProperty("--oy", ((y / rect.height) * 100).toFixed(2) + "%");
                    img.style.setProperty("--scale", 2.4);
                    img.style.setProperty("--tx", "0px");
                    img.style.setProperty("--ty", "0px");

                    slide.classList.add("pslb-zoomed");
                    swiperInstance.allowTouchMove = false;
                }

                img.addEventListener("dblclick", (ev) => { ev.preventDefault(); toggle(ev); });

                let lt = 0;
                img.addEventListener("touchend", (ev) => {
                    const now = Date.now();
                    const d = now - lt;
                    lt = now;
                    if (d < 280) { ev.preventDefault(); toggle(ev); }
                }, { passive: false });
            });
        }

        window.__PS_OPEN_LIGHTBOX__ = openLightbox;
    });
</script>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const root = document.getElementById("PsColorSlider-{{ product.id }}");
        if (!root) return;

        if (root.querySelector(".pslb-trigger")) return;

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "pslb-trigger";
        btn.setAttribute("aria-label", "Zoom images");
        btn.innerHTML = `
    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2"/>
      <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M10.5 7v7M7 10.5h7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
  `;

        btn.addEventListener("click", function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (e.stopImmediatePropagation) e.stopImmediatePropagation();

            const slides = Array.from(root.querySelectorAll(".product-media-slider .swiper-slide"));
            const seen = new Set();
            const uniqueIds = [];
            slides.forEach(s => {
                const id = s.getAttribute("data-media-id") || s.dataset.mediaId;
                if (id && !seen.has(String(id))) { seen.add(String(id)); uniqueIds.push(String(id)); }
            });

            const active = root.querySelector(".product-media-slider .swiper-slide.swiper-slide-active");
            const activeId = active ? (active.getAttribute("data-media-id") || active.dataset.mediaId) : null;
            const idx = activeId ? Math.max(0, uniqueIds.indexOf(String(activeId))) : 0;

            if (window.__PS_OPEN_LIGHTBOX__) window.__PS_OPEN_LIGHTBOX__(idx);
        });

        root.appendChild(btn);
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const root = document.getElementById("PsColorSlider-{{ product.id }}");
        if (!root) return;

        const FLAG = "__PS_INLINE_ZOOM_INSTALLED__" + "{{ product.id }}";
        if (window[FLAG]) return;
        window[FLAG] = true;

        const sliderEl = root.querySelector(".product-media-slider");
        const getSwiper = () => (sliderEl && sliderEl.swiper) ? sliderEl.swiper : null;

        const getNum = (v) => {
            if (!v) return 0;
            const n = parseFloat(String(v).replace("px", ""));
            return Number.isFinite(n) ? n : 0;
        };
        const clamp = (n, min, max) => Math.max(min, Math.min(max, n));

        function setDefaults(img) {
            img.style.setProperty("--scale", 1);
            img.style.setProperty("--ox", "50%");
            img.style.setProperty("--oy", "50%");
            img.style.setProperty("--tx", "0px");
            img.style.setProperty("--ty", "0px");
            img.classList.remove("is-panning");
        }

        function resetAllZoom() {
            root.querySelectorAll("img.slider-media").forEach(img => setDefaults(img));
            root.querySelectorAll(".swiper-slide.ps-inline-zoomed").forEach(slide => {
                requestAnimationFrame(() => slide.classList.remove("ps-inline-zoomed"));
            });
            const sw = getSwiper();
            if (sw) sw.allowTouchMove = true;
        }

        function toggleZoom(imgEl, clientX, clientY) {
            const slide = imgEl.closest(".swiper-slide");
            if (!slide) return;

            const already = slide.classList.contains("ps-inline-zoomed");
            if (already) {
                setDefaults(imgEl);
                requestAnimationFrame(() => slide.classList.remove("ps-inline-zoomed"));
                const sw = getSwiper();
                if (sw) sw.allowTouchMove = true;
                return;
            }

            resetAllZoom();

            const rect = imgEl.getBoundingClientRect();
            const x = Math.max(0, Math.min(clientX - rect.left, rect.width));
            const y = Math.max(0, Math.min(clientY - rect.top, rect.height));
            const ox = (x / rect.width) * 100;
            const oy = (y / rect.height) * 100;

            slide.classList.add("ps-inline-zoomed");
            imgEl.style.setProperty("--ox", ox.toFixed(2) + "%");
            imgEl.style.setProperty("--oy", oy.toFixed(2) + "%");
            imgEl.style.setProperty("--scale", 2.35);
            imgEl.style.setProperty("--tx", "0px");
            imgEl.style.setProperty("--ty", "0px");

            const sw = getSwiper();
            if (sw) sw.allowTouchMove = false;
        }

        let down = false, sx = 0, sy = 0, stx = 0, sty = 0, activeImg = null;

        function getMax(img) {
            const scale = parseFloat(getComputedStyle(img).getPropertyValue("--scale")) || 1;
            const rect = img.getBoundingClientRect();
            const baseW = rect.width / scale;
            const baseH = rect.height / scale;
            const maxX = Math.max(0, (baseW * scale - baseW) / 2);
            const maxY = Math.max(0, (baseH * scale - baseH) / 2);
            return { maxX, maxY };
        }

        root.addEventListener("pointerdown", function (e) {
            const img = e.target.closest("img.slider-media");
            if (!img) return;

            const slide = img.closest(".swiper-slide");
            if (!slide || !slide.classList.contains("ps-inline-zoomed")) return;

            down = true;
            activeImg = img;
            img.classList.add("is-panning");
            try { img.setPointerCapture(e.pointerId); } catch (err) { }

            sx = e.clientX; sy = e.clientY;
            stx = getNum(getComputedStyle(img).getPropertyValue("--tx"));
            sty = getNum(getComputedStyle(img).getPropertyValue("--ty"));

            e.preventDefault();
            e.stopPropagation();
            if (e.stopImmediatePropagation) e.stopImmediatePropagation();
        }, true);

        root.addEventListener("pointermove", function (e) {
            if (!down || !activeImg) return;
            const slide = activeImg.closest(".swiper-slide");
            if (!slide || !slide.classList.contains("ps-inline-zoomed")) return;

            const { maxX, maxY } = getMax(activeImg);
            const dx = e.clientX - sx;
            const dy = e.clientY - sy;

            const ntx = clamp(stx + dx, -maxX, maxX);
            const nty = clamp(sty + dy, -maxY, maxY);

            activeImg.style.setProperty("--tx", ntx.toFixed(2) + "px");
            activeImg.style.setProperty("--ty", nty.toFixed(2) + "px");

            e.preventDefault();
            e.stopPropagation();
            if (e.stopImmediatePropagation) e.stopImmediatePropagation();
        }, true);

        function endPan(e) {
            if (!down) return;
            down = false;
            if (activeImg) {
                activeImg.classList.remove("is-panning");
                try { activeImg.releasePointerCapture(e.pointerId); } catch (err) { }
            }
            activeImg = null;
        }
        root.addEventListener("pointerup", endPan, true);
        root.addEventListener("pointercancel", endPan, true);
        root.addEventListener("pointerleave", endPan, true);

        root.addEventListener("click", function (e) {
            const img = e.target.closest("img.slider-media");
            if (!img) return;
            e.preventDefault();
            e.stopPropagation();
            if (e.stopImmediatePropagation) e.stopImmediatePropagation();
        }, true);

        root.addEventListener("dblclick", function (e) {
            const img = e.target.closest("img.slider-media");
            if (!img) return;
            e.preventDefault();
            e.stopPropagation();
            if (e.stopImmediatePropagation) e.stopImmediatePropagation();
            toggleZoom(img, e.clientX, e.clientY);
        }, true);

        let lastTapTs = 0;
        root.addEventListener("touchend", function (e) {
            const img = e.target.closest("img.slider-media");
            if (!img) return;

            const now = Date.now();
            const delta = now - lastTapTs;
            lastTapTs = now;

            if (delta < 280) {
                const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : null;
                if (!t) return;

                e.preventDefault();
                e.stopPropagation();
                if (e.stopImmediatePropagation) e.stopImmediatePropagation();
                toggleZoom(img, t.clientX, t.clientY);
            }
        }, { passive: false, capture: true });

        const sw = getSwiper();
        if (sw && sw.on) {
            sw.on("slideChangeTransitionStart", resetAllZoom);
            sw.on("touchStart", function () {
                const zoomed = root.querySelector(".swiper-slide.ps-inline-zoomed");
                if (zoomed) resetAllZoom();
            });
        }

        root.querySelectorAll("img.slider-media").forEach(img => setDefaults(img));
    });
</script>


<script>
  (function () {
    function cleanMoneyText(str) {
      if (!str) return str;
      return str
        .replace(/([.,]00)\s*$/,'')
        .replace(/([.,]00)(?=\D*$)/,'');
    }

    function cleanAll(root) {
      (root || document).querySelectorAll(".money").forEach(function (el) {
        var t = el.textContent || "";
        var nt = cleanMoneyText(t.trim());
        if (nt !== t.trim()) el.textContent = nt;
      });
    }

    document.addEventListener("DOMContentLoaded", function () {
      cleanAll(document);

      var mo = new MutationObserver(function (muts) {
        muts.forEach(function (m) {
          if (m.target) cleanAll(m.target);
          if (m.addedNodes && m.addedNodes.length) {
            m.addedNodes.forEach(function (n) {
              if (n.nodeType === 1) cleanAll(n);
            });
          }
        });
      });

      mo.observe(document.body, { childList: true, subtree: true, characterData: true });
    });
  })();
</script>
