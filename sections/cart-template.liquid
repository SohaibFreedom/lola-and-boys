{% comment %}
  ** Cart page - default view **
  - Template section
{% endcomment %}
{% liquid
  assign savedby = cart.items | where: 'vendor', 'SavedBy' | first
  assign totalPrice = cart.total_price | minus: savedby.final_price
  assign cartCount = cart.item_count
  if savedby
    assign cartCount = cartCount | minus: 1
  endif
  assign cartData = cart.items
%}

{{ 'cart-custom.css' | asset_url | stylesheet_tag: preload: true }}

<a name="pagecontent" id="pagecontent"></a>

<div id="CartContainer">
  <div id="currency-format" data-money-format="{{ shop.money_format }}"></div>
  <div class="main-container cart-temp-header">
    <div class="row">
      <div class="wi-100">
        <div class="page-title">
          <h1>{{ 'cart.general.title' | t }} ({{ cartCount }})</h1>
        </div>
      </div>
    </div>
  </div>

  {% if cartCount == 0 %}
    <div class="sixteen columns">
      <div class="section clearfix">
        <div class="six columns offset-by-five">
          <p class="quote">{{ 'cart.general.continue_browsing_html' | t }}</p>

          <a
            href="{% if cart.items.first.product.collections != blank %}{{ cart.items.first.product.collections.last.url }}{% else %}/collections/all{% endif %}"
            class="action_button continue-button add_to_cart"
          >
            {{- 'cart.general.continue_shopping_link_html' | t -}}
          </a>
        </div>
        <br class="clear">
      </div>
    </div>
  {% else %}
    <div class="main-container">
      <div class="row">
        <div class="wi-100">
          <form action="/cart" method="post" id="cart_form">
            <div class="section clearfix cart-section-row">
              <div class="ten columns cart-section-left">
                <div class="custom-patch-cart-data"></div>
                {% assign total_saving = 0 %}
                {% for item in cart.items %}
                  {% if item.properties._Timestamp %}
                    {% continue %}
                  {% endif %}
                  {% if item.vendor == 'SavedBy' %}
                    {% continue %}
                  {% endif %}
                  {% include 'wh_calculate_discount' with item.product %}
                  {% include 'wh_variant' with item.variant %}
                  {% assign wh_line_price = wh_v_price | minus: 0 | times: item.quantity %}

                  {% if wh_v_compare_at_price > wh_v_price %}
                    {% assign saving = wh_v_compare_at_price | minus: wh_line_price %}
                    {% assign total_saving = saving | plus: total_saving %}
                  {% endif %}

                  <div class="section clearfix cart_content_row" data-id="{{ item.product.id }}">
                    <div class="three columns alpha cart_content_img">
                      <a href="{{ item.url }}" title="{{ item.title | escape }}" class="cart_page_image">
                        {% if item.properties._customized_image_url_front %}
                          <img
                            src="{{ item.properties._customized_image_url_front}}"
                            alt="{{ item.title | escape }}"
                            class="lazyload {{ settings.image_loading_style }}"
                            style="max-width: {{- item.image.width -}}px"
                            data-sizes="auto"
                            data-src="{{ item | img_url: '900x' }}"
                            data-srcset="
                               {{ item.properties._customized_image_url_front }} 300w,
                              {{ item.properties._customized_image_url_front }} 600w,
                              {{ item.properties._customized_image_url_front }} 900w
                            "
                          >
                        {% else %}
                          <img
                            src="{{ item | img_url: '100x' }}"
                            alt="{{ item.title | escape }}"
                            class="lazyload {{ settings.image_loading_style }}"
                            style="max-width: {{- item.image.width -}}px"
                            data-sizes="auto"
                            data-src="{{ item | img_url: '900x' }}"
                            data-srcset="
                              {{ item | img_url: '300x' }} 300w,
                              {{ item | img_url: '600x' }} 600w,
                              {{ item | img_url: '900x' }} 900w
                            "
                          >
                        {% endif %}
                      </a>
                    </div>

                    <div class="seven columns omega cart_content_info">
                      <h3>
                        <a href="{{ item.url }}" class="cart-product-title-c">
                          {{- item.product.title }}
                          <span class="saso-cart-item-discount-notes" data-key="{{item.key}}"></span>
                          <span class="saso-cart-item-upsell-notes" data-key="{{item.key}}"></span>
                        </a>
                      </h3>

                      {% if item.product.title == 'Gift Wrapping' %}
                        <p class="cart-attribute__field">
                          <label for="gift-message">Gift Message</label>
                          <textarea
                            id="gift-message"
                            type="text"
                            name="attributes[Gift Message]"
                            value="{{ cart.attributes["Gift Message"] }}"
                          ></textarea>
                        </p>
                      {% endif %}
                      {% if item.product.title == 'Gift Card' %}
                        <p class="cart-attribute__field">
                          <label for="gift-message">Gift Message</label>
                          <textarea
                            id="gift-message"
                            type="text"
                            name="attributes[Gift Message-2]"
                            value="{{ cart.attributes["Gift Message-2"] }}"
                          ></textarea>
                        </p>
                      {% endif %}

                      {% unless item.product.has_only_default_variant or item.variant.title contains 'Title' %}
                        <p class="meta">
                          {% for option in item.product.options %}
                            <span class="label">{{ option }}:</span>
                            <span>{{ item.variant.options[forloop.index0] }}</span><br>
                          {% endfor %}

                          <span class="label">Qty:</span>
                          <span class="cart-line-qty-display">{{ item.quantity }}</span><br>
                          <span class="cart-line-qty-error" style="display:none;color:#c00;font-size:12px;"></span>
                        </p>
                      {% endunless %}

                      <span
                        class="Bold-theme-hook-DO-NOT-DELETE bold_cart_item_properties"
                        style="display:none !important;"
                      ></span>
                      {%- if item.properties %}
                        <p>
                          {% for p in item.properties %}
                            {%- if p.first contains 'Gift' -%}{%- continue -%}{%- endif -%}
                            {%- if p.first.first == '_' -%}{%- continue -%}{%- endif -%}
                            {% unless p.last == blank or p.first == '_preorder_locale' %}
                              {% if p.last contains '/uploads/' %}
                                <div>
                                  {% unless p.first contains '_is_preorder' -%}
                                    {%- unless p.first == '_is_preorder' %}{{ p.first }}:{% endunless -%}
                                  {%- endunless %}
                                  <a class="lightbox" href="{{ p.last }}">{{ 'cart.general.uploaded_file' | t }}</a>
                                </div>
                              {% else %}
                                <div>
                                  {% unless p.first contains '_is_preorder' -%}
                                    {%- unless p.first == '_is_preorder' %}{{ p.first }}:{% endunless -%}
                                  {%- endunless %}
                                  {{ p.last }}
                                </div>
                              {% endif %}
                            {% endunless %}
                          {% endfor %}
                        </p>
                      {% endif %}

                      <div class="modal_price cart-temp_price">
                        {% if wh_v_compare_at_price > item.price %}
                          <span
                            class="c-cart__itemPrice c-cart__itemdiscountedprice"
                            style="text-decoration: line-through;"
                            rv-html="item.final_line_price | money Currency.currentCurrency"
                            class="c-cart__itemPrice"
                          >
                            {{ wh_v_compare_at_price | money }}
                          </span>

                          <span
                            class="c-cart__itemPrice"
                            rv-html="item.discounted_line_price | money Currency.currentCurrency"
                            class="c-cart__itemPrice"
                          >
                            {{ item.discounted_price | money }}
                          </span>

                        {% elsif item.original_price > item.discounted_price %}
                          <span
                            class="c-cart__itemPrice c-cart__itemdiscountedprice"
                            style="text-decoration: line-through;"
                            rv-html="item.final_line_price | money Currency.currentCurrency"
                            class="c-cart__itemPrice"
                          >
                            {{ item.original_price | money }}
                          </span>

                          <span
                            class="c-cart__itemPrice"
                            rv-html="item.discounted_line_price | money Currency.currentCurrency"
                            class="c-cart__itemPrice"
                          >
                            {{ item.discounted_price | money }}
                          </span>

                        {% else %}
                          <span
                            class="c-cart__itemPrice"
                            rv-html="item.discounted_line_price | money Currency.currentCurrency"
                            class="c-cart__itemPrice"
                          >
                            {{ item.original_price | money }}
                          </span>
                        {% endif %}
                      </div>

                      <div class="cart-action-btn-flex-c">
                        <cart-remove-button
                          id="Remove-{{ item.index | plus: 1 }}"
                          data-index="{{ item.index | plus: 1 }}"
                          data-item-key="{{ item.key }}"
                        >
                          <a
                            href="{{ item.url_to_remove }}"
                            class="button button--tertiary"
                            aria-label="{{ 'remove' | t: title: item.title }}"
                            onclick="removeItem(event, '{{ item.url_to_remove }}')"
                          >
                            Remove
                          </a>
                        </cart-remove-button>

                        {% assign product_handle_full = item.url %}
                        {%- assign product_handle_no_query = product_handle_full | split: '?' | first -%}
                        {%- assign product_handle_filtered = product_handle_no_query | remove: '/products/' -%}

                        <wishlist-button-collection data-product-handle="{{ product_handle_filtered }}" show-icon="" icon="wishlist" align-self="center" align-content="center" floating="{&quot;reference&quot;:&quot;[wk-id=\&quot;PKfLVkO8BZyS1zm57EObx\&quot;]&quot;position&quot;:{&quot;placement&quot;:&quot;top-end&quot;,&quot;inset&quot;:true}}" wk-loaded="" data-preorder-handle="mia-pink-fringe-dress">
                          <wk-button class="wk-floating" style="position: absolute; top: 0px; left: 0px; transition: none; transform: translate3d(216px, 0px, 0px);">
                            <button type="button" aria-label="Add to Wishlist" class="wk-button wk-align-center wk-align-content-center">
                              Move to favorites
                            </button>
                          </wk-button>
                        </wishlist-button-collection>
                        <div class="heading-cart-change">Edit</div>

                      </div>

                      <div class="change-btn-cart-flex">
                        <div class="quanitty-toggle-cart">
                          <div class="product-quantity-box left">
                            <span class="ss-icon product-minus js-change-quantity" data-func="minus">
                              <span class="icon-minus"></span>
                            </span>
                            <input
                              type="number"
                              min="0"
                              size="2"
                              class="quantity"
                              name="updates[]"
                              {% unless item.variant.inventory_management == blank
                                or item.variant.inventory_policy == 'continue'
                              %}
                                max="{{ item.variant.inventory_quantity }}"
                              {% endunless %}
                              id="updates_{{ item.id }}"
                              value="{{ item.quantity }}"
                              data-line-id="{{ forloop.index }}"
                              data-item-key="{{ item.key }}"
                              {% if settings.limit_quantity
                                and item.variant.inventory_management != blank
                                and item.variant.inventory_quantity > 0
                                and item.variant.inventory_policy == 'deny'
                              %}
                                max="{{ item.variant.inventory_quantity }}"
                              {% endif %}
                            >
                            <span class="ss-icon product-plus js-change-quantity" data-func="plus">
                              <span class="icon-plus"></span>
                            </span>
                          </div>
                          <div class="cancel-quantity-toggle">
                            <span class="cancel-cart-btn">Cancel</span>
                            <span type="button" class="update-cart-btn" fdprocessedid="8mpijr">Update</span>
                          </div>
                        </div>
                      </div>

                    </div>
                  </div>
                {% endfor %}
              </div>

              <div class="five columns offset-by-one cart-right-section">
                <div class="section clearfix">
                  <div class="subtotal">
                    <h4 class="order-summery">ORDER SUMMARY</h4>
                    <div class="subtotal-top">
                      <p class="cart_subtotal js-cart_subtotal">
                        <span class="right">
                          <span class="">
                            <span class="saso-cart-original-total">
                              <span
                                class="Bold-theme-hook-DO-NOT-DELETE bold_cart_total"
                                style="display:none !important;"
                              ></span>
                              <span class="wh-original-cart-total">
                                <span class="ak-upsell-original-price">{{ totalPrice | money }}</span>
                                <span class="ak-upsell-cart-total"></span>
                              </span>
                              <span class="wh-cart-total"></span>
                              <div class="additional-notes">
                                <span class="wh-minimums-note"></span><span class="wh-extra-note"></span>
                              </div>
                            </span>
                            <span class="saso-cart-total"></span>
                          </span>
                        </span>
                        <span>{{ 'cart.general.subtotal' | t }} ({{ cart.item_count | t }}) </span>
                        <span class="sale-tax">sales tax calculated at checkout.</span>
                        <div class="payment-icons-custom">
                          <img src="https://cdn.shopify.com/s/files/1/0002/0647/1226/files/afterpay-logo-cus.png?v=1732745014" height="auto" width="auto" />
                          <img src="https://cdn.shopify.com/s/files/1/0002/0647/1226/files/paypal-custom_50349735-fce2-4c5c-b7b1-21da83415513.png?v=1732744318" height="auto" width="auto" />
                          <img src="https://cdn.shopify.com/s/files/1/0002/0647/1226/files/shoppay-custom.png?v=1732821864" height="auto" width="auto" />
                        </div>
                      </p>
                    </div>
                    
                    {% if section.settings.display_savings %}
                      <p class="cart_savings sale">
                        {% if total_saving > 0 %}
                          <span class="right">
                            <span class="">{{ total_saving | money }}</span>
                          </span>
                          <span>{{ 'layout.general.savings' | t }}</span>
                        {% endif %}
                      </p>
                    {% endif %}
    
                    {% if settings.show_multiple_currencies %}
                      <p>
                        <small>
                          {{ 'cart.general.orders_processed_in_currency_html' | t: currency: shop.currency }}
                        </small>
                      </p>
                    {% endif %}

                    {% if section.settings.display_special_instructions %}
                      <label for="note">{{ 'cart.general.note' | t: shop_name: shop.name }}:</label>
                      <textarea id="note" name="note" rows="2">{{ cart.note }}</textarea>
                    {% endif %}

                    {% if section.settings.display_tos_checkbox %}
                      <p>
                        <input type="checkbox" class="tos_agree" id="cart_agree" required>
                        <label class="tos_label" for="cart_agree">
                          {{ 'cart.general.agree_to_terms_html' | t }}
                        </label>
                        {% if settings.tos_page != blank %}
                          <a href="{{ pages[settings.tos_page].url }}" target="_blank" class="tos_icon">
                            {{- 'cart.general.view_terms' | t -}}
                          </a>
                        {% endif %}
                      </p>
                    {% endif %}

                    {%- comment -%} Swipe Package Protection anchor {%- endcomment -%}
                    <div class="Swipe-div"></div>

                    <input
                      type="submit"
                      class="action_button add_to_cart checkout-cart-page"
                      id="checkout"
                      name="checkout"
                      value="proceed to checkout"
                    >

                    {% if section.settings.cart_message != blank %}
                      <div>
                        {{ section.settings.cart_message }}
                      </div>
                    {% endif %}

                    <p>
                      <!-- Store pickup include on cart -->
                      {% include 'creativer-store-pickup_v1_3' %}
                    </p>
                    <div></div>
                    {% if content_for_additional_checkout_buttons %}
                      <div class="additional-checkout-buttons">
                        {% comment %}CreativeR | Store Pickup{% endcomment %}
                        {% comment %}{{ content_for_additional_checkout_buttons }}{% endcomment %}
                      </div>
                    {% endif %}
                    {% if shop.metafields.wh_net.enabled -%}
                      {%- if customer.tags contains 'whnet' %}
                        <div style="margin-top:30px;">
                          <p>{{ shop.metafields.wh_net.wh_net_text }}</p>
                          <a id="wh-30-open" class="button">{{ shop.metafields.wh_net.wh_net_button_text }}</a>
                        </div>
                      {% endif -%}
                    {%- endif %}

                    {% if cartCount > 0 %}
                      <div class="featured-links">
                        <a href="https://lolaandtheboys.com/collections/newarrivals" class="secondary_button">
                          {{- 'cart.general.continue_shopping_link_html' | t -}}
                        </a>
                      </div>
                    {% endif %}
                    <savedby-widget cart-page></savedby-widget>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <wishlist-page 
      show-product-title  
      show-price
      show-vendor
      show-buy-all-button
      cta-button="add-to-cart"
      product-options="dropdowns"
      move-to-cart
      wishlist-empty-link="/collections/all"
    ></wishlist-page>
    
    <!-- Cross sell integration -->
    {% include 'cross-sell' %}

    {% include 'cart-shipping-calculator' %}
  {% endif %}
</div> <!-- /#CartContainer -->

<script>
  // Reload only the cart HTML via AJAX (no full page reload)
  function reloadCartSection(callback) {
    var $cartWrapper = $('#CartContainer');
    if (!$cartWrapper.length) {
      window.location.reload();
      return;
    }
    var url = window.location.pathname + window.location.search;
    $cartWrapper.addClass('is-loading');
    $cartWrapper.load(url + ' #CartContainer > *', function (response, status) {
      $cartWrapper.removeClass('is-loading');
      if (status === 'error') {
        window.location.reload();
        return;
      }
      if (typeof callback === 'function') {
        callback();
      }
    });
  }

  // Cart update helper with stock message + plus disable
   function updateCartLineByKey(itemKey, quantity, maxLimit, requestedQty) {
    if (!itemKey) return;
    var payload = { updates: {} };
    payload.updates[itemKey] = quantity;

    return fetch(window.Shopify.routes.root + 'cart/update.js', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify(payload)
    })
    .then(function(res){ return res.json(); })
    .then(function(data){
      var itemFromKey = data.items.find(function(item){
        return item.key === itemKey;
      });
      var updatedQty = itemFromKey ? itemFromKey.quantity : 0;

      reloadCartSection(function() {
        var input = document.querySelector('#cart_form input.quantity[data-item-key="' + itemKey + '"]');
        if (!input) return;

        var row = input.closest('.cart_content_row');
        if (!row) return;

        var displayEl = row.querySelector('.cart-line-qty-display');
        var errorEl   = row.querySelector('.cart-line-qty-error');
        var plusBtn   = row.querySelector('.product-quantity-box .js-change-quantity[data-func="plus"]');

        // qty sync
        input.value = updatedQty;
        if (displayEl) {
          displayEl.textContent = updatedQty;
        }

        // sab se pehle clear
        if (errorEl) {
          errorEl.textContent = '';
          errorEl.style.display = 'none';
        }

        var limit = maxLimit || updatedQty;

        // agar updatedQty limit pe hi hai (max stock pe khada hai) -> plus disable
        if (plusBtn) {
          if (updatedQty >= limit) {
            plusBtn.style.opacity = '0.4';
            plusBtn.style.pointerEvents = 'none';
          } else {
            plusBtn.style.opacity = '';
            plusBtn.style.pointerEvents = '';
          }
        }

        // agar user ne limit se zyada maanga tha -> red message show
        if (requestedQty && requestedQty > limit && errorEl) {
          errorEl.textContent = 'Only ' + limit + ' in stock';
          errorEl.style.display = 'inline';
        }
      });

      return data;
    })
    .catch(function(err){
      console.error('Cart update error', err);
      window.location.reload();
    });
  }

  // Override old removeItem to use AJAX + section reload
  function removeItem(event, urlToRemove) {
    event.preventDefault();
    var btn = event.target;
    var wrapper = btn.closest('cart-remove-button');
    var itemKey = wrapper ? wrapper.getAttribute('data-item-key') : null;

    if (!itemKey) {
      window.location.href = urlToRemove;
      return;
    }
    updateCartLineByKey(itemKey, 0);
  }
</script>

<!-- app snippet js – your original logic, kept -->
<script>
  function fetchCartDataAndUpdateVariable() {
    fetch(window.Shopify.routes.root + 'cart.js', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    })
    .then(response => {
      return response.json();
    })
    .then(data => {
      allCartData = data.items || [];
    })
    .catch(error => {
      console.error('Error fetching cart data:', error);
    });
  }

  var allCartData = [];

  function handleDeleteButtonClick(event) {
    var timestamp = event.target.dataset.customizedTimestamp;
    var itemIdsToDelete = [];

    allCartData.forEach(function(item) {
      if (item.properties && item.properties._Timestamp === timestamp) {
        itemIdsToDelete.push(item.key);
      }
    });

    if (itemIdsToDelete.length > 0) {
      console.log("Items to delete:", itemIdsToDelete);

      var updates = {};
      itemIdsToDelete.forEach(itemId => {
        updates[itemId] = 0;
      });

      fetch(window.Shopify.routes.root + 'cart/update.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ updates })
      })
      .then(response => response.json())
      .then(data => {
        console.log("Update response:", data);
        console.log("All specified items have been deleted.");
        reloadCartSection();
      })
      .catch(error => {
        console.error('Error updating cart:', error);
      });
    } else {
      console.log("No items found with the specified timestamp.");
    }
  }

  document.addEventListener('click', function(event) {
    if (event.target.classList.contains('cart_delete-custom-product-button')) {
      var deleteButtons = document.querySelectorAll('.cart_delete-custom-product-button');
      deleteButtons.forEach(function(deleteButton) {
        deleteButton.style.pointerEvents = 'none';
        deleteButton.style.opacity = '0.5';
      });
      handleDeleteButtonClick(event);
    }
  });
</script>

<script>
  var cartData = {{ cartData | json }};
  console.log(cartData);
  const timestampMap = {};
  let specificVariantPrice = 0;

  cartData.forEach(item => {
    console.log(item.variant_id);
    if (item.variant_id === 42085140430950) {
      console.log('true')
      specificVariantPrice = item.price; 
    }
  });
  console.log('stiching price',specificVariantPrice)

  cartData.forEach(item => {
    if (item.properties._Timestamp) {
      const timestamp = item.properties._Timestamp;
      if (!timestampMap[timestamp]) {
        timestampMap[timestamp] = [];
      }
      if (item.properties._customized_image_url_front) {
        console.log('in');
        const imageUrl = item.properties._customized_image_url_front;
        const backImageUrl = item.properties._customized_image_url_back ;
        const priceProduct = item.properties._patches_price;
        const timestamp = item.properties._Timestamp;
        if (item.properties._embroideryProduct === 'Embroidery Product'){
          const textfont = item.properties.Font;
          const fontcolor = item.properties["Font Color"]; 
          const priceProduct1 = item.price;
          let finalPrice = priceProduct1 + Number(specificVariantPrice);
          timestampMap[timestamp].push({
            emb:'Embroidery',
            title: item.title,
            price:  Number(finalPrice) / 100,
            imageUrl: imageUrl,
            parentVariant: 'parent',
            timestampp: timestamp,
            textfont:textfont,
            fontcolor:fontcolor
          });
        }
        else{
          timestampMap[timestamp].push({
            title: item.title,
            price: priceProduct,
            imageUrl: imageUrl,
            parentVariant: 'parent',
            backImage: backImageUrl,
            timestampp: timestamp
          });
        }
      } else {
        const timestamp = item.properties._Timestamp; 
        const imageUrl = item.image;
        const priceProduct = String(item.price);
        const removedecimal = parseFloat(priceProduct.slice(0, -2));
        timestampMap[timestamp].push({
          title: item.title,
          price: removedecimal,
          imageUrl: imageUrl,
          parentVariant: item.properties._parent_variant,
          timestampp: timestamp
        });
      }
    }
  });

  const filteredAndGroupedData = [];
  for (const timestamp in timestampMap) {
    filteredAndGroupedData.push(timestampMap[timestamp]);
  }

  const customPatchCartData = document.querySelector('.custom-patch-cart-data');

  filteredAndGroupedData.forEach(timestampGroup => {
    const parentPatchProductDetailsDiv = document.createElement('div');
    parentPatchProductDetailsDiv.classList.add('parent-patch-product-details');

    const parentChildWrapperDiv = document.createElement('div');
    parentChildWrapperDiv.classList.add('parent-child-wrapper');
    timestampGroup.forEach(item => {
      if (item.parentVariant === 'parent') {
        var deletebutton = document.createElement('a');
        deletebutton.classList.add('cart_delete-custom-product-button');
        deletebutton.textContent = 'remove';
        deletebutton.setAttribute('data-customized-timestamp', item.timestampp);
        deletebutton.setAttribute('disabled', 'true');
        parentChildWrapperDiv.appendChild(deletebutton);
        
        window.addEventListener('load', function() {
          setTimeout(function() {
            deletebutton.removeAttribute('disabled');
          }, 3000);
        });
        if (item.emb === 'Embroidery'){
          var textFontDiv = document.createElement('div');
          textFontDiv.classList.add('child-item');
          var textFontP = document.createElement('p');
          textFontP.textContent = 'Font: ' + item.textfont;
          textFontDiv.appendChild(textFontP);
          parentChildWrapperDiv.appendChild(textFontDiv);

          var fontColorDiv = document.createElement('div');
          fontColorDiv.classList.add('child-item');
          var fontColorP = document.createElement('p');
          fontColorP.textContent = 'Font Color: ' + item.fontcolor;
          fontColorDiv.appendChild(fontColorP);
          parentChildWrapperDiv.appendChild(fontColorDiv);
        }
      }
    });

    const parentPriceTitleDiv = document.createElement('div');
    parentPriceTitleDiv.classList.add('parent-price-title');

    console.log(timestampMap)
    timestampGroup.forEach(item => {

      const div = document.createElement('div');
      div.classList.add(item.parentVariant === 'parent' ? 'parent-item' : 'child-item');

      const title = document.createElement('h3');
      title.textContent = item.title;

      var currencyFormat = document.getElementById('currency-format').dataset.moneyFormat;
      var amountPlaceholder = currencyFormat.match(/\{\{amount\}\}\}/)[0];
      var currencySymbol = currencyFormat.replace(amountPlaceholder, '');

      const titleAndPrice = document.createElement('p');
      if (item.parentVariant === 'parent') {
        if (item.emb === 'Embroidery'){
          titleAndPrice.textContent = `${currencySymbol} ${item.price}`;
        }else{
          titleAndPrice.textContent = `${item.price}`;
        }
      } else {
        titleAndPrice.textContent = `${item.title} - ${currencySymbol} ${item.price}`;
      }

      const img = document.createElement('img');
      const backimg =document.createElement('img')
      if(item.parentVariant === 'parent' ){
        img.src = item.imageUrl;
        img.alt = 'Parent Image';
        img.classList.add('parent-image','front-image');
        backimg.src = item.backImage;
        backimg.alt = 'Back Image';
        backimg.classList.add('parent-image','back-image' );
      }else{
        img.src = item.imageUrl;
        img.alt = 'Child Image';
        img.classList.add('child-image');   
      }

      div.appendChild(titleAndPrice);
      div.appendChild(img);
      div.appendChild(backimg);

      if (item.parentVariant === 'parent') {
        parentPriceTitleDiv.appendChild(title);
        parentPriceTitleDiv.appendChild(titleAndPrice);
      }
      if (item.parentVariant === 'parent') {
        parentPatchProductDetailsDiv.appendChild(div);
      }
      else {
        parentChildWrapperDiv.appendChild(div);
      }

    });

    parentChildWrapperDiv.appendChild(parentPriceTitleDiv);

    parentPatchProductDetailsDiv.appendChild(parentChildWrapperDiv);

    customPatchCartData.appendChild(parentPatchProductDetailsDiv);
  });

  function modifyWishlistButton(button) {
    if (
      button &&
      document.body.classList.contains('cart') &&
      button.closest('.cart-section-left')
    ) {
      const svg = button.querySelector('svg');
      if (svg) {
        svg.remove();
      }
      button.textContent = 'Move to Favorites';
    }
  }

  const observer = new MutationObserver((mutationsList) => {
    mutationsList.forEach((mutation) => {
      if (mutation.type === 'childList') {
        mutation.addedNodes.forEach((node) => {
          if (
            node.nodeType === 1 &&
            node.matches('.cart-section-left button.wk-button')
          ) {
            modifyWishlistButton(node);
          }

          if (node.nodeType === 1) {
            const buttons = node.querySelectorAll(
              '.cart-section-left button.wk-button'
            );
            buttons.forEach(modifyWishlistButton);
          }
        });
      }
    });
  });

  observer.observe(document.body, {
    childList: true,
    subtree: true,
  });

  document.addEventListener('click', function(event) {
    if (event.target.classList.contains('heading-cart-change')) {
      document.querySelectorAll('.cart-action-btn-flex-c, .change-btn-cart-flex')
        .forEach(function(element) {
          element.classList.add('active');
        });
    }

    if (event.target.classList.contains('cancel-cart-btn')) {
      document.querySelectorAll('.cart-action-btn-flex-c, .change-btn-cart-flex')
        .forEach(function(element) {
          element.classList.remove('active');
        });
    }

    // UPDATE button → AJAX update with stock logic
    if (event.target.classList.contains('update-cart-btn')) {
      var row = event.target.closest('.cart_content_row');
      if (!row) return;
      var input = row.querySelector('input.quantity');
      if (!input) return;

      var requested = parseInt(input.value, 10);
      if (isNaN(requested) || requested < 0) requested = 0;

      var maxAttr = input.getAttribute('max');
      var max = maxAttr ? parseInt(maxAttr, 10) : null;
      var finalQty = requested;

      if (max !== null && requested > max) {
        finalQty = max;
      }

      var itemKey = input.getAttribute('data-item-key');
      if (!itemKey) return;

      updateCartLineByKey(itemKey, finalQty, max, requested);
    }
  });
</script>

{% comment %} <script>
  // AJAX quantity + stock check
  (function() {
    ...
  })();
</script> {% endcomment %}

<script>
  $(document).ready(function () {
    const elementMap = {};

    $('.cart-product-title-c').each(function () {
      const text = $(this).text().trim();
      elementMap[text] = $(this).closest('.cart_content_row');
    });

    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.addedNodes && mutation.addedNodes.length > 0) {
          $(mutation.addedNodes).find('a.wk-text-link').each(function () {
            handleDynamicElement($(this));
          });
        }
      });
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true,
    });

    setInterval(() => {
      $('a.wk-text-link').each(function () {
        handleDynamicElement($(this));
      });
    }, 1000);

    function handleDynamicElement($element) {
      const text = $element.text().trim();
      const parentRow = elementMap[text];
      if (parentRow) {
        const button = parentRow.find('button.wk-button.wk-align-center.wk-align-content-center');
        if (!button.hasClass('active-class')) {
          button.addClass('active-class').text('Remove from Favorites');
        }
      }

      $('.wk-button.wk-align-center.wk-align-content-center.wk-selected.active-class').click(function (e) {
        e.preventDefault();
        $(this).text('Move to Favorites');
        console.log('Button with active class clicked.');
      });
    }

    console.log('Script is running with MutationObserver and periodic checks.');
  });
</script>


<script>
// Cart page: AJAX remove (no fade, no manual DOM delete)
document.addEventListener('click', function (e) {
  // Only handle Remove link in cart page form
  var removeAnchor = e.target.closest('#cart_form cart-remove-button a.button--tertiary');
  if (!removeAnchor) return;

  e.preventDefault();
  e.stopImmediatePropagation();

  var wrapper = removeAnchor.closest('cart-remove-button');
  if (!wrapper) return;

  var itemKey = wrapper.getAttribute('data-item-key');
  if (!itemKey) return;

  // Just call your existing AJAX helper: qty 0 = remove line
  if (typeof updateCartLineByKey === 'function') {
    updateCartLineByKey(itemKey, 0);
  } else {
    // Hard fallback if something breaks
    window.location.href = removeAnchor.getAttribute('href');
  }
}, true);
</script>

{% schema %}
{
  "name": "Cart page",
  "class": "cart-section",
  "settings": [
    {
      "type": "checkbox",
      "id": "display_special_instructions",
      "label": "Show \"note\" text box"
    },
    {
      "type": "checkbox",
      "id": "display_tos_checkbox",
      "label": "Show \"agree to terms\" checkbox"
    },
    {
      "type": "checkbox",
      "id": "display_savings",
      "label": "Show total savings",
      "default": true
    },
    {
      "type": "richtext",
      "id": "cart_message",
      "label": "Cart message"
    }
  ]
}
{% endschema %}

<!-- GPO installed -->
